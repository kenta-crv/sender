# 要件定義書：お問い合わせフォーム自動送信システム

## 1. プロジェクト概要

### 1.1 目的
BtoB企業のお問い合わせフォームに対し、営業メッセージを自動で入力・送信するシステムを構築する。

### 1.2 システム構成
- **フレームワーク**: Ruby on Rails 6.1.7
- **Ruby**: 3.1.6
- **ブラウザ自動操作**: Selenium WebDriver + Chrome
- **OS**: Windows
- **データベース**: 既存のRailsアプリケーション内のCustomer/Callモデルを使用

### 1.3 主要ファイル
| ファイル | 役割 |
|---------|------|
| `app/services/form_sender.rb` | コア処理（フォーム検出・入力・送信・成功判定） |
| `app/models/customer.rb` | 送信先企業情報（contact_url等） |
| `app/models/call.rb` | 送信結果の記録（call_typeでphone/formを区別） |
| `app/models/form_submission_batch.rb` | バッチ送信の進捗管理 |
| `app/jobs/form_send_job.rb` | Sidekiqジョブ（自己チェイン方式で1件ずつ処理） |
| `app/controllers/form_submissions_controller.rb` | バッチ管理画面のコントローラ |
| `config/initializers/sidekiq.rb` | Redis接続設定 |

---

## 2. 送信者情報（固定値）

| 項目 | 値 | 備考 |
|------|-----|------|
| 名前 | 山口 俊二 | 姓名分割にも対応 |
| フリガナ（カタカナ） | ヤマグチ シュンジ | |
| ふりがな（ひらがな） | やまぐち しゅんじ | フォームの指定に応じて自動切替 |
| メール | mail1@ebisu-hotel.tokyo | |
| 電話番号 | 050-7119-1716 | ハイフン付き。分割入力にも対応 |
| 郵便番号 | 104-0061 | 分割入力にも対応 |
| 住所 | 東京都中央区銀座6-13-16 | |
| 都道府県 | 東京都 | セレクトボックス用 |
| 会社名 | 自営業 | company系フィールドに入力 |

---

## 3. 処理フロー

```
1. DBからCustomerを取得（contact_urlが設定されているもの）
      ↓
2. Selenium（Chrome）でcontact_urlにアクセス
      ↓
3. フォームの入力欄を自動検出
   - input, textarea, select要素を走査
   - name属性、id属性、placeholder、ラベルテキストからフィールド種別を判定
      ↓
4. フィールドに応じた値を自動入力
   - 必須フィールドと重要フィールドを優先的に入力
   - 同意チェックボックスを自動チェック
   - 必須ラジオボタングループを自動選択
      ↓
5. 送信ボタンをクリック（1回目）
      ↓
6. 確認画面の判定
   - 確認画面であれば、送信ボタンを再クリック（2回目）
   - 「戻る」ボタンを避けて「送信」ボタンを優先選択
      ↓
7. 送信成功/失敗を判定
   - 成功メッセージの検出
   - URL変更の検出
   - フォーム消失の検出
      ↓
8. 結果をCallモデルに記録
      ↓
9. 次のCustomerへ → 繰り返し
```

---

## 4. フォーム検出ロジック（詳細）

### 4.1 フィールド検出キーワード

| フィールド | 検出キーワード |
|-----------|--------------|
| 名前 | name, 名前, お名前, 氏名, your-name, fullname, full_name, shimei, simei, 担当者, ご担当者, 担当 |
| フリガナ | kana, カナ, かな, フリガナ, ふりがな, furigana, name_kana, kna |
| メール | email, mail, メール, e-mail, your-email, メールアドレス, eml, m_address |
| メール確認 | email_confirm, mail_confirm, 確認用, confirm, re-email, eml2 |
| 電話 | tel, phone, 電話, 携帯, telephone, your-tel, denwa |
| 郵便番号 | zip, postal, 郵便, 〒, yubin, post-code, zipcode |
| 都道府県 | prefecture, pref, 都道府県, todoufuken, todofuken, ken |
| 会社名 | company, 会社, 御社, 貴社, organization, 社名, company_name, kaisya, comname, 御社名, 会社名, corpname, corp, 法人 |
| 住所 | address, 住所, 所在地, your-address, jusho, adr, add |
| 本文 | message, body, 内容, お問い合わせ内容, inquiry, comment, お問い合わせ, 備考, remarks, naiyo, toi, その他, content, contents, ques |

### 4.2 分割フィールド対応

以下のフィールドは分割入力に対応：
- **電話番号**: tel1/tel2/tel3、[data][0]/[data][1]/[data][2]
- **郵便番号**: zip1/zip2、[data][0]/[data][1]
- **名前**: name1/name2（姓・名）、ラベルで「姓」「名」判定
- **フリガナ**: kana_sei/kana_mei、カタカナ/ひらがな自動切替

### 4.3 必須フィールド判定（7段階）

1. HTML属性 `required`、`aria-required="true"`
2. ラベルテキストに必須マーク（`*`, `※`, `必須`, `required`, `（必須）`）
3. `label[for]` 要素のテキスト
4. 直前の兄弟要素（label, span, th, dt）
5. 親がlabel要素の場合
6. テーブルレイアウト: 同じ行の`<th>`要素
7. dl/dt/ddレイアウト: 前の`<dt>`要素

### 4.4 重要フィールド判定

必須マークがなくても入力するフィールド：
- 名前、メール、電話番号、会社名、フリガナ、郵便番号、住所
- textareaはメッセージ欄のみ（住所等のtextareaは除外）
- 部署名フィールドは除外

---

## 5. 送信ボタン検出ロジック

### 5.1 検出キーワード
`送信`, `確認`, `submit`, `send`, `入力内容を確認`, `送信する`, `確認する`, `確認画面へ`, `次へ`

### 5.2 検出優先順位

1. **CSS セレクタ**: `input[type='submit']`, `input[type='image']`, `button[type='submit']`, `button:not([type])`
2. **ボタン優先度ソート**:
   - 優先度0（高）: 「送信」「submit」「send」を含むボタン
   - 優先度1（中）: その他のボタン
   - 優先度2（低）: 「戻る」「back」「修正」を含むボタン
3. **テキスト検索**: XPathで送信キーワードを含む要素（button, input, a, span, div）
4. **最終手段**: JavaScriptで`form.submit()`を直接実行

---

## 6. 確認画面検出ロジック

送信ボタンが表示されていることを前提に、以下の3パターンで判定：

### パターン1: キーワード + 編集不可
- 確認キーワード（「確認画面」「入力内容の確認」「送信してよろしいですか」等15種）がページに存在
- 編集可能な入力欄が3個未満
- → 確認画面と判定

### パターン2: 入力欄消失
- 表示されている入力欄が1個以下
- 全入力欄は2個以上ある（元々フォームがあった）
- → 確認画面と判定（MW WP Form等）

### パターン3: 入力欄非表示化
- 全入力欄が3個以上
- 非表示の入力欄が表示中の入力欄より多い
- → 確認画面と判定（CF7確認アドオン等）

### バリデーションエラー除外
- 確認キーワードがあっても、編集可能な入力欄が3個以上ある場合は確認画面とみなさない
- → バリデーションエラーでページが再表示されたケースに対応

---

## 7. 送信成功判定ロジック

### 7.1 判定優先順位

1. **アラートエラー検出**: バリデーションエラーのアラートがあった場合は即失敗
2. **成功メッセージ検出**（最優先）:
   - キーワード: `ありがとう`, `完了`, `受付`, `送信しました`, `送信完了`, `thank`, `success`, `受け付けました`, `受付いたしました`, `送信いたしました`, `お問い合わせいただき`, `送信されました`
3. **URL変更検出**:
   - URL変更 + フォーム消失（入力欄2個以下） + 送信ボタン非表示 → 成功
   - URLパス変更 → 成功
   - URLクエリ変更 → 成功
   - プロトコル/フラグメントのみの変更 → 成功とみなさない
4. **フォーム消失検出**:
   - 表示中の入力欄が1個以下 + 送信ボタン非表示 → 成功
   - 送信ボタンがまだ表示中 → 確認画面の可能性として成功とみなさない

### 7.2 偽成功防止（False Positive対策）
- 入力欄が消えても送信ボタンが残っている場合は成功とみなさない（確認画面を成功と誤判定しない）
- プロトコルのみのURL変更（http→https）は成功とみなさない

### 7.3 リトライ機構
- 初回判定で失敗した場合、3秒待機後に再判定を実施（AJAX応答やページ遷移の遅延対策）

---

## 8. 同意チェックボックス・ラジオボタン処理

### 8.1 同意チェックボックス
- 検出キーワード: `同意`, `agree`, `規約`, `プライバシー`, `privacy`, `policy`, `承諾`, `確認しました`, `了承`, `confirm`, `個人情報`
- name属性、id属性、ラベルテキスト、親要素テキストから検出

### 8.2 ラジオボタン
- 必須と判定されたグループのみ選択
- 優先キーワード: `その他`, `他`, `other`, `お問い合わせ`, `ご相談`, `相談`, `サービス`, `一般`, `general`
- 回避キーワード: `採用`, `求人`, `recruit`, `個人情報`, `苦情`, `クレーム`, `返品`, `返金`

### 8.3 必須チェックボックスグループ
- 件名選択チェックボックス等に対応
- 同意系チェックボックスとは別処理

---

## 9. 実行モード

| モード | 説明 |
|--------|------|
| 通常モード | フォーム入力→自動送信→結果判定 |
| 確認モード (`confirm_mode: true`) | フォーム入力後に停止、手動確認を待つ |
| デバッグモード (`debug: true`) | 処理ログを標準出力に表示 |
| DB保存モード (`save_to_db: true`) | 送信結果をCallモデルに保存 |
| ヘッドレスモード (`headless: true`) | ブラウザ非表示で実行（Sidekiq環境用） |

---

## 10. 送信結果ステータス

| status | 意味 |
|--------|------|
| 送信成功 | フォーム送信が正常に完了した |
| 送信失敗 | 送信ボタンが見つからない、または送信後の確認ができなかった |
| フォーム未検出 | contact_urlが未設定、またはフィールドが不足（2個未満） |
| アクセス失敗 | URLにアクセスできなかった（WebDriverError） |
| エラー | その他の予期しないエラー |
| 確認完了 | 確認モードで入力完了（手動確認済み） |

---

## 11. テスト結果と改善履歴

### 11.1 初回バッチテスト（100件）
- 送信成功: 88件
- 送信失敗: 10件（ID: 9, 14, 28, 35, 37, 47, 59, 84, 93, 99）
- フォーム未検出: 残り

### 11.2 失敗原因の分析と対応

#### 修正完了（5件）

| ID | 企業名 | 原因 | 修正内容 |
|----|--------|------|---------|
| 9 | 三栄フーズ | 電話番号バリデーションエラー（ハイフンなし拒否）+ 確認画面誤判定 + 偽成功検出 | 電話番号をハイフン付きに変更、確認画面判定に編集可能入力欄チェック追加、フォーム消失判定に送信ボタン存在チェック追加 |
| 37 | 和光化学 | 郵便番号・住所が未入力（重要フィールド未判定） | important_field?にzip, address追加。確認画面を入力欄消失パターンで検出 |
| 84 | 田村屋 | th要素の必須マーク（※）未検出、フリガナ/郵便番号/住所が未入力 | required_field?にth/dt要素チェック追加、important_field?にname_kana, zip, address追加 |
| 93 | 神谷電化工業 | confirm[]チェックボックス未チェック | CONSENT_PATTERNSに`confirm`追加 |
| 99 | 鶴崎海陸運輸 | 部分改善：個人情報同意チェックボックス対応 | CONSENT_PATTERNSに`個人情報`追加（ラジオボタン問題は残存） |

#### 未修正（5件）- サイト側の制限

| ID | 企業名 | 原因 | 備考 |
|----|--------|------|------|
| 14 | キコーテック | CF7で「お客様情報」必須ラジオボタン未選択 | 特殊なラジオボタン構造 |
| 28 | 飯島畜産 | reCAPTCHA保護 | プログラムでの突破不可 |
| 35 | 深作農園 | CF7サーバーエラー（スパム対策） | サイト側のスパムフィルタ |
| 47 | マスイ製菓 | 単一ページフォーム、URL変更がプロトコルのみ | 成功判定の改善余地あり |
| 59 | 大道産業 | 「営業目的でのご利用はお断り」+ バリデーションエラー | 営業フォーム送信を拒否するサイト |

### 11.3 2回目バッチテスト（途中: 63/100件）

| ステータス | 件数 |
|-----------|------|
| 送信成功 | 20件 |
| 送信失敗 | 11件 |
| フォーム未検出 | 32件 |

- ID:9, 37の修正を確認済み
- ID:84, 93, 99は未到達（テスト途中で中断）
- 新規失敗として6, 11, 15, 26, 34, 55が発生（リグレッションか一時的問題か要確認）

---

## 12. 主要な改善内容まとめ

### 12.1 電話番号フォーマット
- **変更前**: ハイフンなし（`05071191716`）
- **変更後**: ハイフン付き（`050-7119-1716`）
- **理由**: 多くのフォームがハイフン付きのバリデーションを要求

### 12.2 確認画面検出の刷新
- 3パターン検出（キーワード+入力状態、入力欄消失、入力欄非表示化）
- バリデーションエラーとの誤判定を防止（編集可能入力欄が3個以上なら確認画面とみなさない）

### 12.3 偽成功防止（False Positive対策）
- フォーム消失時に送信ボタンの存在をチェック
- URL変更時もフォーム消失+送信ボタン非表示を確認
- プロトコルのみの変更は成功とみなさない

### 12.4 送信ボタン優先度
- 確認画面で「戻る」ボタンと「送信」ボタンが共存する場合に「送信」を優先選択
- `btn.text.presence` で空文字列の問題を解決

### 12.5 必須フィールド検出強化
- テーブルレイアウト（th/td）のマーク検出
- dl/dt/ddレイアウトのマーク検出

### 12.6 重要フィールド拡張
- フリガナ、郵便番号、住所を重要フィールドに追加

### 12.7 同意チェックボックス拡張
- `confirm`、`個人情報` をパターンに追加

---

## 13. 既知の制限事項

1. **reCAPTCHA/hCaptcha**: プログラムでの突破は不可能
2. **サーバー側スパムフィルタ**: CF7等のスパム対策プラグインによるブロック
3. **営業お断りフォーム**: フォーム自体が営業目的の送信を拒否する設定
4. **特殊なラジオボタン構造**: 一部のフォームで必須ラジオボタンのラベル検出が困難
5. **単一ページフォーム（SPAタイプ）**: URL変更がないため成功判定が難しい場合がある
6. **AJAX送信フォーム**: ページ遷移なしの送信は成功メッセージの表示待ちが必要（リトライで対応）

---

## 14. バッチ送信機能（フェーズ3〜4）

### 14.1 アーキテクチャ

```
管理画面（/form_submissions）
  ↓ バッチ作成（顧客を選択して送信開始）
FormSubmissionBatch（DBに進捗を記録）
  ↓
FormSendJob（Sidekiqジョブ: form_submissionキュー）
  ↓ 自己チェイン方式: 1件処理 → 次のジョブを投入
FormSender（headlessモードで実行）
  ↓
Call（結果をcall_type: 'form'で保存）
```

### 14.2 DBスキーマ追加

| テーブル/カラム | 型 | 説明 |
|---------------|-----|------|
| `customers.contact_url` | string | お問い合わせフォームURL |
| `calls.call_type` | string (default: 'phone') | 'phone' or 'form' |
| `form_submission_batches` | table | バッチ進捗管理テーブル |

**form_submission_batches カラム:**
- `total_count`, `processed_count`, `success_count`, `failure_count` - 件数管理
- `status` - pending / processing / completed / cancelled
- `current_customer_id` - 現在処理中の顧客
- `customer_ids` - JSON配列（送信対象の顧客ID）
- `error_log` - JSON配列（エラー情報）
- `started_at`, `completed_at` - 実行時刻

### 14.3 管理画面（/form_submissions）

| パス | メソッド | 機能 |
|------|---------|------|
| `/form_submissions` | GET | バッチ一覧・新規作成画面 |
| `/form_submissions` | POST | バッチ作成 & ジョブ開始 |
| `/form_submissions/:id` | GET | バッチ詳細・結果表示 |
| `/form_submissions/:id/cancel` | PATCH | バッチキャンセル |
| `/form_submissions/:id/progress` | GET | JSON API（AJAX進捗ポーリング用） |

### 14.4 FormSendJob 仕様
- **キュー**: `form_submission`（優先度3）
- **リトライ**: なし（フォーム送信失敗は再送しても同じ結果になるため）
- **処理方式**: 自己チェイン（1件処理後に次のジョブを`perform_later`で投入）
- **キャンセル対応**: 各ジョブ実行時にバッチのstatusを確認、cancelledなら停止

---

## 15. 残作業

### 15.1 直近
- [ ] 2回目バッチテストの残り（ID:65〜100）を完了
- [ ] 新規失敗6件（ID:6, 11, 15, 26, 34, 55）のデバッグ確認
- [ ] リグレッションがあれば修正
- [x] コミット & GitHubへプッシュ
- [x] 発注者への結果報告

### 15.2 フェーズ5（テスト・調整）

**【発注者に事前確認が必要な事項】**
- 本番送信の対象件数（全290件 or 一部）
- 送信タイミング（いつ実行するか）
- 既に送信済みの企業を除外するか
- テスト用に数件だけ先に送って確認するかどうか

※ 同じ企業に重複送信しないよう、Call.form_submissionsの履歴で送信済みを除外可能

**【テスト項目】**
- [ ] 少数テスト（3〜5件の未送信企業で、バッチ機能の動作確認）
- [ ] 送信成功率の検証（目標60%）
- [ ] エラーハンドリングの確認
- [ ] パフォーマンス調整
- [ ] 管理画面のUI調整（発注者の要望に応じて）

### 15.3 案件終了後
- [ ] Rubyをアンインストールする
